<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <meta name="robots" content="index, follow">
    <meta property="og:locale" content="nl_NL">
    <meta property="og:type" content="article">
    <meta property="og:title" content="PE1HVH - XIAO SAMD21 WebUSB Configurator">
    <meta property="og:description" content="Configurator for Seeeduino Morse CW Interface. Set the interface for using it for by example PCWFistCechk, Learn Morse Online or Vband etc.">
    <meta property="og:url" content="https://www.pe1hvh.nl/">
    <meta property="og:site_name" content="pe1hvh">

    <title>XIAO SAMD21 WebUSB Configurator</title>
    <script lang="text/javascript" src="js/simple-web-serial.min.js"></script>
    <!--script lang="text/javascript" src="js/pe1hvh.js"></script-->

    <link rel="stylesheet" href="css/pe1hvh.css">
</head>
<body>
    <h1>XIAO SAMD21 WebUSB Configuration</h1>
    <button id="connect">Connect to Serial Port</button>

    <br><br>
    <table style="border:0px;">

        <tr>
            <td>
                <label for="typeMorseKey">Type Morse Key:</label>
            </td>
            <td>
                <select id="typeMorseKey">
                    <option value="0">Straight Key</option>
                    <option value="1">Sidesweeper</option>
                    <option value="2">Paddle</option>
                </select>
            </td>

        </tr>

        <tr>
            <td>
                <label for="typeEvent">Type Event:</label>
            </td>
            <td>
                <select id="typeEvent">
                    <option value="0">Mouse</option>
                    <option value="1">Keyboard</option>
                </select>

            </td>
        </tr>

        <tr>
            <td>
                <label for="leftEvent">Event 1 (=Pin 6):</label>
            </td>
            <td>
                <select id="leftEvent">
                    <!-- Options will be dynamically populated based on typeEvent -->
                </select>
            </td>
        </tr>

        <tr id="rightEventRow" style="display: none;">
            <td>
                <label for="rightEvent">Event 2 (=Pin 7):</label>
            </td>
            <td>
                <div id="rightEventContainer">
                    <select id="rightEvent">
                        <!-- Options will be dynamically populated based on typeEvent -->
                    </select>
                </div>
            </td>
        </tr>

    </table>
    <br> <button id="send" class="button black">Send to XIAO</button>

    <p id="status"></p>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            const connectButton = document.getElementById('connect');
            const sendButton = document.getElementById('send');
            const statusParagraph = document.getElementById('status');

            const typeMorseKeySelect = document.getElementById('typeMorseKey');
            const typeEventSelect = document.getElementById('typeEvent');
            const leftEventSelect = document.getElementById('leftEvent');
            const rightEventSelect = document.getElementById('rightEvent');
            const rightEventRow = document.getElementById('rightEventRow');

            let port;
            let writer;
            let reader;

            // Functie 1: Verbinding opzetten met de seriële poort
            async function connectSerial() {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });

                    writer = port.writable.getWriter();
                    reader = port.readable.getReader();

                    statusParagraph.textContent = 'Verbonden met seriële poort';
                    connectButton.disabled = true;
					// Initial data load
                    requestInitialData();

                } catch (error) {
                    statusParagraph.textContent = 'Fout bij verbinden: ' + error;
                }
            }

            // Functie 2: Initiële data laden van Seeeduino
            async function requestInitialData() {
                if (!port) {
                    statusParagraph.textContent = 'Niet verbonden met seriële poort';
                    return;
                }

                try {
                    // Stuur een verzoek naar de Seeeduino om de initiële waarden te verzenden
                    await writer.write(new TextEncoder().encode("get_initial_values\n"));

                    // Wacht op de reactie van de Seeeduino
                    let response = await readSerialData();
					console.log("raw data: "+ response);
                    // Parse de JSON-data en vul de input velden
                    if (response) {
                        let data = JSON.parse(response);
						console.log("json data: "+ data);
                        typeMorseKeySelect.value = data.typeMorseKey;
                        typeEventSelect.value = data.typeEvent;
                        leftEventSelect.value = data.leftEvent;
                        rightEventSelect.value = data.rightEvent;
                        updateRightEventVisibility();
                        updateEventOptions();
                        statusParagraph.textContent = 'Initiële data geladen';
                    }
                } catch (error) {
                    statusParagraph.textContent = 'Fout bij ophalen initiële data: ' + error;
                }
            }

            // Functie 3: Data verzenden naar de Seeeduino
            async function sendData() {
                if (!port) {
                    statusParagraph.textContent = 'Niet verbonden met seriële poort';
                    return;
                }

                const data = {
                    typeMorseKey: parseInt(typeMorseKeySelect.value),
                    typeEvent: parseInt(typeEventSelect.value),
                    leftEvent: leftEventSelect.value,
                    rightEvent: rightEventSelect.value
                };

                try {
                    // Serialiseer de data naar JSON en verstuur het
                    await writer.write(new TextEncoder().encode("update_values:" + JSON.stringify(data) + "\n"));
                    statusParagraph.textContent = 'Data verzonden naar Seeeduino';
                } catch (error) {
                    statusParagraph.textContent = 'Fout bij verzenden data: ' + error;
                }
            }

            // Helper functie om seriële data te lezen
            async function readSerialData() {
                let textDecoder = new TextDecoder();
                let data = "";
                while (true) {
                    const { value, done } = await reader.read();
                    data += textDecoder.decode(value);
                    if (data.includes('\n')) {
                        data = data.replace('\n', '');
                        return data;
                    }
                    if (done) {
                        return data;
                    }
                }
            }

            function updateRightEventVisibility() {
                if (typeMorseKeySelect.value === '2') {
                    rightEventRow.style.display = 'table-row';
                } else {
                    rightEventRow.style.display = 'none';
                }
            }

            typeMorseKeySelect.addEventListener('change', updateRightEventVisibility);

            function updateEventOptions() {
                const selectedType = typeEventSelect.value;
                const options = selectedType === '0' ? getMouseOptions() : getKeyboardOptions();

                [leftEventSelect, rightEventSelect].forEach(select => {
                    select.innerHTML = '';
                    options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        select.appendChild(optionElement);
                    });
                });
            }

            function getMouseOptions() {
                return [
                    { value: '0', text: 'Left Click' },
                    { value: '1', text: 'Right Click' },
                    { value: '2', text: 'Middle Click' }
                ];
            }

            function getKeyboardOptions() {
                return [
                    { value: '0x80', text: 'Left Control Key' },
                    { value: '0x81', text: 'Left Shift Key' },
                    { value: '0x82', text: 'Left Alt Key' },
                    { value: '0x84', text: 'Right Control Key' },
                    { value: '0x85', text: 'Right Shift Key' },
                    { value: '0x86', text: 'Right Alt Key' }
                ];
            }

            typeEventSelect.addEventListener('change', updateEventOptions);
            updateEventOptions(); // Initial population of options
            updateRightEventVisibility(); // Initial visibility check

            // Event listeners voor de knoppen
            connectButton.addEventListener('click', connectSerial);
            sendButton.addEventListener('click', sendData);
        });

    </script>
</body>
</html>

